SET SERVEROUTPUT ON SIZE UNLIMITED;

/* ============================================================================
   SISTEMA: SKINTRADE â€“ PUBLICACIÃ“N Y GESTIÃ“N DE SKINS
============================================================================ */

-- ============================================================================
-- RESET SEGURO (DROP VIEW / PACKAGE / TABLAS SI EXISTEN)
-- ============================================================================
BEGIN EXECUTE IMMEDIATE 'DROP VIEW V_PUBLICACIONES_ACTIVAS'; 
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN EXECUTE IMMEDIATE 'DROP PACKAGE PKG_MERCADO'; 
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
  FOR t IN (
    SELECT table_name FROM user_tables
    WHERE table_name IN (
      'ORDENES','PUBLICACIONES','ARTICULOS','SKINS','MODELOS_ARMA','CATEGORIAS_PRODUCTO',
      'MOVIMIENTOS_BILLETERA','BILLETERA_USUARIO','USUARIOS','REGLAS_COMISION'
    )
  ) LOOP
    EXECUTE IMMEDIATE 'DROP TABLE '||t.table_name||' CASCADE CONSTRAINTS';
  END LOOP;
END;
/
-- ============================================================================
-- CATÃ�LOGOS
-- ============================================================================
CREATE TABLE CATEGORIAS_PRODUCTO(
  ID_CATEGORIA NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  NOMBRE       VARCHAR2(50) NOT NULL UNIQUE
);

CREATE TABLE MODELOS_ARMA(
  ID_MODELO    NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  ID_CATEGORIA NUMBER NOT NULL REFERENCES CATEGORIAS_PRODUCTO(ID_CATEGORIA),
  NOMBRE       VARCHAR2(80) NOT NULL,
  CONSTRAINT UK_MODELO UNIQUE(ID_CATEGORIA,NOMBRE)
);

CREATE TABLE SKINS(
  ID_SKIN     NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  ID_MODELO   NUMBER NOT NULL REFERENCES MODELOS_ARMA(ID_MODELO),
  NOMBRE      VARCHAR2(100) NOT NULL,
  RAREZA      VARCHAR2(30) NOT NULL,
  CONSTRAINT UK_SKIN UNIQUE(ID_MODELO,NOMBRE)
);

-- ============================================================================
-- USUARIOS + BILLETERA
-- ============================================================================
CREATE TABLE USUARIOS(
  ID_USUARIO   NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  USERNAME     VARCHAR2(40)  NOT NULL UNIQUE,
  EMAIL        VARCHAR2(120) NOT NULL UNIQUE,
  PASS_HASH    VARCHAR2(200) NOT NULL,
  PAIS         VARCHAR2(2),
  NIVEL_KYC    NUMBER DEFAULT 0 CHECK(NIVEL_KYC IN(0,1,2)),
  ESTADO       VARCHAR2(15) DEFAULT 'ACTIVO' CHECK(ESTADO IN('ACTIVO','SUSPENDIDO','PENDIENTE')),
  CREADO_EN    TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE BILLETERA_USUARIO(
  ID_USUARIO NUMBER PRIMARY KEY REFERENCES USUARIOS(ID_USUARIO),
  SALDO_CLP  NUMBER(16,0) DEFAULT 0 NOT NULL CHECK(SALDO_CLP>=0)
);

CREATE TABLE MOVIMIENTOS_BILLETERA(
  ID_MOV       NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  ID_USUARIO   NUMBER NOT NULL REFERENCES USUARIOS(ID_USUARIO),
  TIPO         VARCHAR2(20) NOT NULL CHECK(TIPO IN('DEPOSITO','RETIRO','PAGO_COMPRA','ABONO_VENTA','COMISION')),
  MONTO_CLP    NUMBER(16,0) NOT NULL CHECK(MONTO_CLP>=0),
  REF_TX       VARCHAR2(50),
  ESTADO       VARCHAR2(15) DEFAULT 'OK' CHECK(ESTADO IN('OK','PENDIENTE','FALLIDO')),
  CREADO_EN    TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- ============================================================================
-- ARTÃ�CULOS y PUBLICACIONES
-- ============================================================================
CREATE TABLE ARTICULOS(
  ID_ARTICULO     NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  ID_SKIN         NUMBER NOT NULL REFERENCES SKINS(ID_SKIN),
  ID_DUENIO       NUMBER NOT NULL REFERENCES USUARIOS(ID_USUARIO),
  DESGASTE        NUMBER(5,4) NOT NULL CHECK(DESGASTE BETWEEN 0 AND 1),
  EXTERIOR        VARCHAR2(25) NOT NULL CHECK(EXTERIOR IN('FACTORY NEW','MINIMAL WEAR','FIELD-TESTED','WELL-WORN','BATTLE-SCARRED')),
  ES_STATTRAK     CHAR(1) DEFAULT 'N' CHECK(ES_STATTRAK IN('S','N')),
  ES_SOUVENIR     CHAR(1) DEFAULT 'N' CHECK(ES_SOUVENIR IN('S','N')),
  INDICE_PATRON   NUMBER(4),
  NOMBRE_ETIQUETA VARCHAR2(32)
);
CREATE INDEX IX_ARTICULOS_DUENIO ON ARTICULOS(ID_DUENIO);

CREATE TABLE PUBLICACIONES(
  ID_PUBLICACION NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  ID_ARTICULO    NUMBER NOT NULL REFERENCES ARTICULOS(ID_ARTICULO),
  ID_VENDEDOR    NUMBER NOT NULL REFERENCES USUARIOS(ID_USUARIO),
  PRECIO_CLP     NUMBER(16,0) NOT NULL CHECK(PRECIO_CLP>0),
  ESTADO         VARCHAR2(15) DEFAULT 'ACTIVA' CHECK(ESTADO IN('ACTIVA','VENDIDA','CANCELADA')),
  CREADO_EN      TIMESTAMP DEFAULT SYSTIMESTAMP
);
CREATE INDEX IX_PUB_VENDEDOR_EST ON PUBLICACIONES(ID_VENDEDOR,ESTADO);

CREATE TABLE ORDENES(
  ID_ORDEN      NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  ID_PUBLICACION NUMBER NOT NULL REFERENCES PUBLICACIONES(ID_PUBLICACION),
  ID_COMPRADOR   NUMBER NOT NULL REFERENCES USUARIOS(ID_USUARIO),
  PRECIO_FINAL_CLP NUMBER(16,0) NOT NULL CHECK(PRECIO_FINAL_CLP>0),
  MONTO_COMISION_CLP NUMBER(16,0) NOT NULL CHECK(MONTO_COMISION_CLP>=0),
  COMPLETADA_EN  TIMESTAMP,
  ESTADO         VARCHAR2(15) DEFAULT 'CREADA' CHECK(ESTADO IN('CREADA','PAGADA','CANCELADA','REEMBOLSADA'))
);

-- ============================================================================
-- COMISIONES
-- ============================================================================
CREATE TABLE REGLAS_COMISION(
  ID_REGLA   NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  PORCENTAJE NUMBER(5,2) NOT NULL CHECK(PORCENTAJE BETWEEN 0 AND 100),
  ACTIVA     CHAR(1) DEFAULT 'S' CHECK(ACTIVA IN('S','N')),
  VIGENTE_DESDE DATE NOT NULL,
  VIGENTE_HASTA DATE
);

-- ============================================================================
-- VISTA
-- ============================================================================
CREATE OR REPLACE VIEW V_PUBLICACIONES_ACTIVAS AS
SELECT p.ID_PUBLICACION, p.PRECIO_CLP, p.CREADO_EN,
       a.ID_ARTICULO, a.DESGASTE, a.EXTERIOR, a.ES_STATTRAK, a.ES_SOUVENIR, a.INDICE_PATRON,
       s.NOMBRE AS NOMBRE_SKIN, s.RAREZA,
       m.NOMBRE AS NOMBRE_MODELO,
       c.NOMBRE AS CATEGORIA,
       p.ID_VENDEDOR
FROM PUBLICACIONES p
JOIN ARTICULOS a ON a.ID_ARTICULO=p.ID_ARTICULO
JOIN SKINS s ON s.ID_SKIN=a.ID_SKIN
JOIN MODELOS_ARMA m ON m.ID_MODELO=s.ID_MODELO
JOIN CATEGORIAS_PRODUCTO c ON c.ID_CATEGORIA=m.ID_CATEGORIA
WHERE p.ESTADO='ACTIVA';

-- ============================================================================
-- TRIGGERS
-- ============================================================================
-- Trigger fila a fila: crea billetera automÃ¡ticamente
CREATE OR REPLACE TRIGGER TRG_USUARIOS_AI
AFTER INSERT ON USUARIOS FOR EACH ROW
BEGIN
  INSERT INTO BILLETERA_USUARIO(ID_USUARIO,SALDO_CLP) VALUES(:NEW.ID_USUARIO,0);
END;
/
-- Trigger fila a fila: impide doble publicaciÃ³n ACTIVA
CREATE OR REPLACE TRIGGER TRG_PUB_AI
BEFORE INSERT ON PUBLICACIONES FOR EACH ROW
DECLARE v_cnt NUMBER;
BEGIN
  SELECT COUNT(*) INTO v_cnt FROM PUBLICACIONES WHERE ID_ARTICULO=:NEW.ID_ARTICULO AND ESTADO='ACTIVA';
  IF v_cnt>0 THEN
    RAISE_APPLICATION_ERROR(-20002,'El artÃ­culo ya tiene una publicaciÃ³n ACTIVA.');
  END IF;
END;
/
-- Trigger a nivel de SENTENCIA 
CREATE OR REPLACE TRIGGER TRG_PUB_AS
AFTER INSERT ON PUBLICACIONES
BEGIN
  DBMS_OUTPUT.PUT_LINE('Trigger de sentencia activado: se insertaron publicaciones.');
END;
/
-- ============================================================================
-- PACKAGE
-- ============================================================================
CREATE OR REPLACE PACKAGE PKG_MERCADO AS
  -- Excepciones personalizadas
  e_no_duenio     EXCEPTION; PRAGMA EXCEPTION_INIT(e_no_duenio,-20001);
  e_pub_inactiva  EXCEPTION; PRAGMA EXCEPTION_INIT(e_pub_inactiva,-20003);

  -- INTERFAZ PÃšBLICA
  FUNCTION F_PORC_COMISION RETURN NUMBER;
  FUNCTION F_EXTERIOR_DESDE_DESGASTE(p_desgaste NUMBER) RETURN VARCHAR2;

  -- PublicaciÃ³n individual
  PROCEDURE P_PUBLICAR_ARTICULO(p_id_vendedor NUMBER, p_id_articulo NUMBER, p_precio_clp NUMBER);

  -- Compra
  PROCEDURE P_COMPRAR_PUBLICACION(p_id_comprador NUMBER, p_id_publicacion NUMBER);

  -- PublicaciÃ³n MASIVA (procesa varias filas dentro del package)
  PROCEDURE P_PUBLICAR_MASIVO(p_id_vendedor NUMBER, p_precio_clp NUMBER);
END PKG_MERCADO;
/
CREATE OR REPLACE PACKAGE BODY PKG_MERCADO AS
  -- Verifica si un usuario es dueÃ±o de un artÃ­culo.
  FUNCTION is_owner(p_id_vendedor NUMBER, p_id_articulo NUMBER) RETURN BOOLEAN IS
    v_duenio NUMBER;
  BEGIN
    SELECT ID_DUENIO INTO v_duenio FROM ARTICULOS WHERE ID_ARTICULO=p_id_articulo;
    RETURN v_duenio = p_id_vendedor;
  EXCEPTION WHEN NO_DATA_FOUND THEN RETURN FALSE;
  END;

  FUNCTION F_PORC_COMISION RETURN NUMBER IS v NUMBER(5,2);
  BEGIN
    SELECT PORCENTAJE INTO v FROM REGLAS_COMISION
     WHERE ACTIVA='S' AND (VIGENTE_HASTA IS NULL OR VIGENTE_HASTA>=TRUNC(SYSDATE))
     ORDER BY VIGENTE_DESDE DESC FETCH FIRST 1 ROWS ONLY;
    RETURN NVL(v,5);
  EXCEPTION WHEN NO_DATA_FOUND THEN RETURN 5;
  END;

  FUNCTION F_EXTERIOR_DESDE_DESGASTE(p_desgaste NUMBER) RETURN VARCHAR2 IS
  BEGIN
    IF p_desgaste<0.07 THEN RETURN 'FACTORY NEW';
    ELSIF p_desgaste<0.15 THEN RETURN 'MINIMAL WEAR';
    ELSIF p_desgaste<0.38 THEN RETURN 'FIELD-TESTED';
    ELSIF p_desgaste<0.45 THEN RETURN 'WELL-WORN';
    ELSE RETURN 'BATTLE-SCARRED';
    END IF;
  END;

  -- PublicaciÃ³n individual
  PROCEDURE P_PUBLICAR_ARTICULO(p_id_vendedor NUMBER, p_id_articulo NUMBER, p_precio_clp NUMBER) IS 
    v_cnt NUMBER;
  BEGIN
    IF NOT is_owner(p_id_vendedor, p_id_articulo) THEN
      RAISE_APPLICATION_ERROR(-20001,'El usuario no es dueÃ±o del artÃ­culo.');
    END IF;

    SELECT COUNT(*) INTO v_cnt FROM PUBLICACIONES
     WHERE ID_ARTICULO=p_id_articulo AND ESTADO='ACTIVA';
    IF v_cnt>0 THEN
      RAISE_APPLICATION_ERROR(-20002,'El artÃ­culo ya estÃ¡ publicado.');
    END IF;

    INSERT INTO PUBLICACIONES(ID_ARTICULO,ID_VENDEDOR,PRECIO_CLP,ESTADO)
    VALUES(p_id_articulo,p_id_vendedor,p_precio_clp,'ACTIVA');
  END;

  -- PublicaciÃ³n MASIVA
  PROCEDURE P_PUBLICAR_MASIVO(p_id_vendedor NUMBER, p_precio_clp NUMBER) IS
  BEGIN
    FOR a IN (SELECT ID_ARTICULO FROM ARTICULOS WHERE ID_DUENIO=p_id_vendedor) LOOP
      BEGIN
        P_PUBLICAR_ARTICULO(p_id_vendedor,a.ID_ARTICULO,p_precio_clp);
      EXCEPTION WHEN OTHERS THEN NULL; -- continÃºa aunque un artÃ­culo falle
      END;
    END LOOP;
    DBMS_OUTPUT.PUT_LINE('PublicaciÃ³n masiva completada.');
  END;

  -- Compra
  PROCEDURE P_COMPRAR_PUBLICACION(p_id_comprador NUMBER, p_id_publicacion NUMBER) IS
  BEGIN
    NULL;
  END;
END PKG_MERCADO;
/

-- ============================================================================
-- DATOS DE PRUEBA BÃ�SICOS
-- ============================================================================
INSERT INTO CATEGORIAS_PRODUCTO(NOMBRE) VALUES('RIFLE');
INSERT INTO MODELOS_ARMA(ID_CATEGORIA,NOMBRE) SELECT ID_CATEGORIA,'M4A4' FROM CATEGORIAS_PRODUCTO WHERE NOMBRE='RIFLE';
INSERT INTO SKINS(ID_MODELO,NOMBRE,RAREZA) SELECT ID_MODELO,'Redline','COVERT' FROM MODELOS_ARMA WHERE NOMBRE='M4A4';
INSERT INTO USUARIOS(USERNAME,EMAIL,PASS_HASH,PAIS,NIVEL_KYC) VALUES('vendedor01','vendedor01@mail.com','hash','CL',1);
INSERT INTO USUARIOS(USERNAME,EMAIL,PASS_HASH,PAIS,NIVEL_KYC) VALUES('comprador01','comprador01@mail.com','hash','CL',1);
INSERT INTO REGLAS_COMISION(PORCENTAJE,ACTIVA,VIGENTE_DESDE) VALUES(5,'S',TRUNC(SYSDATE)-1);

-- Un artÃ­culo de prueba para el vendedor01
INSERT INTO ARTICULOS(ID_SKIN,ID_DUENIO,DESGASTE,EXTERIOR,ES_STATTRAK,ES_SOUVENIR,INDICE_PATRON,NOMBRE_ETIQUETA)
SELECT s.ID_SKIN,(SELECT ID_USUARIO FROM USUARIOS WHERE USERNAME='vendedor01'),
       0.12,'MINIMAL WEAR','S','N',321,'RED BOOM'
FROM SKINS s WHERE s.NOMBRE='Redline';
COMMIT;

-- ============================================================================
--  Modelos/Skins/Usuarios para publicar varios artÃ­culos --
-- ============================================================================
-- MODELOS
INSERT INTO MODELOS_ARMA(ID_CATEGORIA,NOMBRE)
SELECT c.ID_CATEGORIA,'AK-47' FROM CATEGORIAS_PRODUCTO c
WHERE c.NOMBRE='RIFLE'
  AND NOT EXISTS (SELECT 1 FROM MODELOS_ARMA m WHERE m.NOMBRE='AK-47' AND m.ID_CATEGORIA=c.ID_CATEGORIA);

INSERT INTO MODELOS_ARMA(ID_CATEGORIA,NOMBRE)
SELECT c.ID_CATEGORIA,'AWP' FROM CATEGORIAS_PRODUCTO c
WHERE c.NOMBRE='RIFLE'
  AND NOT EXISTS (SELECT 1 FROM MODELOS_ARMA m WHERE m.NOMBRE='AWP' AND m.ID_CATEGORIA=c.ID_CATEGORIA);

INSERT INTO MODELOS_ARMA(ID_CATEGORIA,NOMBRE)
SELECT c.ID_CATEGORIA,'M4A1-S' FROM CATEGORIAS_PRODUCTO c
WHERE c.NOMBRE='RIFLE'
  AND NOT EXISTS (SELECT 1 FROM MODELOS_ARMA m WHERE m.NOMBRE='M4A1-S' AND m.ID_CATEGORIA=c.ID_CATEGORIA);

-- SKINS
INSERT INTO SKINS(ID_MODELO,NOMBRE,RAREZA)
SELECT m.ID_MODELO,'Vulcan','COVERT' FROM MODELOS_ARMA m
WHERE m.NOMBRE='AK-47'
  AND NOT EXISTS (SELECT 1 FROM SKINS s WHERE s.NOMBRE='Vulcan' AND s.ID_MODELO=m.ID_MODELO);

INSERT INTO SKINS(ID_MODELO,NOMBRE,RAREZA)
SELECT m.ID_MODELO,'Asiimov','COVERT' FROM MODELOS_ARMA m
WHERE m.NOMBRE='AWP'
  AND NOT EXISTS (SELECT 1 FROM SKINS s WHERE s.NOMBRE='Asiimov' AND s.ID_MODELO=m.ID_MODELO);

INSERT INTO SKINS(ID_MODELO,NOMBRE,RAREZA)
SELECT m.ID_MODELO,'Golden Coil','COVERT' FROM MODELOS_ARMA m
WHERE m.NOMBRE='M4A1-S'
  AND NOT EXISTS (SELECT 1 FROM SKINS s WHERE s.NOMBRE='Golden Coil' AND s.ID_MODELO=m.ID_MODELO);

-- USUARIOS extra
INSERT INTO USUARIOS(USERNAME,EMAIL,PASS_HASH,PAIS,NIVEL_KYC)
SELECT 'vendedor02','vendedor02@mail.com','hash','CL',1 FROM dual
WHERE NOT EXISTS (SELECT 1 FROM USUARIOS WHERE USERNAME='vendedor02');

INSERT INTO USUARIOS(USERNAME,EMAIL,PASS_HASH,PAIS,NIVEL_KYC)
SELECT 'vendedor03','vendedor03@mail.com','hash','CL',1 FROM dual
WHERE NOT EXISTS (SELECT 1 FROM USUARIOS WHERE USERNAME='vendedor03');

INSERT INTO USUARIOS(USERNAME,EMAIL,PASS_HASH,PAIS,NIVEL_KYC)
SELECT 'comprador02','comprador02@mail.com','hash','CL',1 FROM dual
WHERE NOT EXISTS (SELECT 1 FROM USUARIOS WHERE USERNAME='comprador02');

COMMIT;

-- Crear ARTÃ�CULOS para cada vendedor
INSERT INTO ARTICULOS(ID_SKIN,ID_DUENIO,DESGASTE,EXTERIOR,ES_STATTRAK,ES_SOUVENIR,INDICE_PATRON,NOMBRE_ETIQUETA)
SELECT s.ID_SKIN,(SELECT ID_USUARIO FROM USUARIOS WHERE USERNAME='vendedor02'),
       0.22,'FIELD-TESTED','N','N',111,'VULCAN #1'
FROM SKINS s
WHERE s.NOMBRE='Vulcan'
  AND NOT EXISTS (SELECT 1 FROM ARTICULOS a WHERE a.NOMBRE_ETIQUETA='VULCAN #1');

INSERT INTO ARTICULOS(ID_SKIN,ID_DUENIO,DESGASTE,EXTERIOR,ES_STATTRAK,ES_SOUVENIR,INDICE_PATRON,NOMBRE_ETIQUETA)
SELECT s.ID_SKIN,(SELECT ID_USUARIO FROM USUARIOS WHERE USERNAME='vendedor03'),
       0.08,'FACTORY NEW','N','S',67,'ASIIMOV #2'
FROM SKINS s
WHERE s.NOMBRE='Asiimov'
  AND NOT EXISTS (SELECT 1 FROM ARTICULOS a WHERE a.NOMBRE_ETIQUETA='ASIIMOV #2');


INSERT INTO ARTICULOS(ID_SKIN,ID_DUENIO,DESGASTE,EXTERIOR,ES_STATTRAK,ES_SOUVENIR,INDICE_PATRON,NOMBRE_ETIQUETA)
SELECT s.ID_SKIN,(SELECT ID_USUARIO FROM USUARIOS WHERE USERNAME='vendedor01'),
       0.10,'MINIMAL WEAR','N','N',456,'COIL #1'
FROM SKINS s
WHERE s.NOMBRE='Golden Coil'
  AND NOT EXISTS (SELECT 1 FROM ARTICULOS a WHERE a.NOMBRE_ETIQUETA='COIL #1');

COMMIT;

-- ============================================================================
-- PRUEBA 1: PUBLICACIÃ“N INDIVIDUAL --
-- ============================================================================
DECLARE
  v_vend USUARIOS.ID_USUARIO%TYPE;
  v_art  ARTICULOS.ID_ARTICULO%TYPE;
BEGIN
  SELECT ID_USUARIO INTO v_vend FROM USUARIOS WHERE USERNAME='vendedor01';
  SELECT ID_ARTICULO INTO v_art FROM ARTICULOS WHERE NOMBRE_ETIQUETA='RED BOOM';
  PKG_MERCADO.P_PUBLICAR_ARTICULO(v_vend,v_art,120000);
END;
/
SELECT * FROM V_PUBLICACIONES_ACTIVAS;

-- ============================================================================
-- PRUEBA 2: PUBLICACIÃ“N MASIVA (si ya estÃ¡ publicado, no duplica)
-- ============================================================================
DECLARE
  v_id_vendedor USUARIOS.ID_USUARIO%TYPE;
BEGIN
  SELECT ID_USUARIO INTO v_id_vendedor
  FROM USUARIOS WHERE USERNAME='vendedor01';

  PKG_MERCADO.P_PUBLICAR_MASIVO(
    p_id_vendedor => v_id_vendedor,
    p_precio_clp  => 99999
  );
END;
/
SELECT COUNT(*) AS total_activas FROM PUBLICACIONES WHERE ESTADO='ACTIVA';
SELECT * FROM V_PUBLICACIONES_ACTIVAS ORDER BY CREADO_EN DESC;

-- Publicar artÃ­culos extra (individual; ignora si ya estÃ¡n publicados)
DECLARE
  v_v1 USUARIOS.ID_USUARIO%TYPE;
  v_v2 USUARIOS.ID_USUARIO%TYPE;
  v_v3 USUARIOS.ID_USUARIO%TYPE;
  v_a1 ARTICULOS.ID_ARTICULO%TYPE; -- RED BOOM (vendedor01)
  v_a2 ARTICULOS.ID_ARTICULO%TYPE; -- VULCAN #1 (vendedor02)
  v_a3 ARTICULOS.ID_ARTICULO%TYPE; -- ASIIMOV #1 (vendedor03)
  v_a4 ARTICULOS.ID_ARTICULO%TYPE; -- COIL #1 (vendedor01)
BEGIN
  SELECT ID_USUARIO INTO v_v1 FROM USUARIOS WHERE USERNAME='vendedor01';
  SELECT ID_USUARIO INTO v_v2 FROM USUARIOS WHERE USERNAME='vendedor02';
  SELECT ID_USUARIO INTO v_v3 FROM USUARIOS WHERE USERNAME='vendedor03';

  SELECT ID_ARTICULO INTO v_a1 FROM ARTICULOS WHERE NOMBRE_ETIQUETA='RED BOOM';
  SELECT ID_ARTICULO INTO v_a2 FROM ARTICULOS WHERE NOMBRE_ETIQUETA='VULCAN #1';
  SELECT ID_ARTICULO INTO v_a3 FROM ARTICULOS WHERE NOMBRE_ETIQUETA='ASIIMOV #2';
  SELECT ID_ARTICULO INTO v_a4 FROM ARTICULOS WHERE NOMBRE_ETIQUETA='COIL #1';

  BEGIN PKG_MERCADO.P_PUBLICAR_ARTICULO(v_v1, v_a1, 120000); EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN PKG_MERCADO.P_PUBLICAR_ARTICULO(v_v2, v_a2, 250000); EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN PKG_MERCADO.P_PUBLICAR_ARTICULO(v_v3, v_a3, 400000); EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN PKG_MERCADO.P_PUBLICAR_ARTICULO(v_v1, v_a4, 180000); EXCEPTION WHEN OTHERS THEN NULL; END;
END;
/

SELECT NOMBRE_ETIQUETA, COUNT(*)
FROM ARTICULOS
WHERE NOMBRE_ETIQUETA IN ('RED BOOM','VULCAN #1','ASIIMOV #1','COIL #1')
GROUP BY NOMBRE_ETIQUETA;

DELETE FROM ARTICULOS
WHERE NOMBRE_ETIQUETA='ASIIMOV #2'
AND ROWNUM = 2; -- elimina uno de ellos

SELECT NOMBRE_ETIQUETA, COUNT(*) AS CANTIDAD
FROM ARTICULOS
WHERE NOMBRE_ETIQUETA IN ('RED BOOM','VULCAN #1','ASIIMOV #1','COIL #1')
GROUP BY NOMBRE_ETIQUETA;
--BORRA ARTICULOS
DELETE FROM ARTICULOS
WHERE NOMBRE_ETIQUETA = 'ASIIMOV #1'
AND ROWID NOT IN (
  SELECT MIN(ROWID) FROM ARTICULOS WHERE NOMBRE_ETIQUETA = 'ASIIMOV #1'
);
COMMIT;



-- Conteo y verificaciÃ³n final
SELECT COUNT(*) AS total_activas FROM PUBLICACIONES WHERE ESTADO='ACTIVA';
SELECT u.USERNAME, m.NOMBRE AS MODELO, COUNT(*) AS pubs_activas
FROM PUBLICACIONES p
JOIN USUARIOS u ON u.ID_USUARIO = p.ID_VENDEDOR
JOIN ARTICULOS a ON a.ID_ARTICULO = p.ID_ARTICULO
JOIN SKINS s ON s.ID_SKIN = a.ID_SKIN
JOIN MODELOS_ARMA m ON m.ID_MODELO = s.ID_MODELO
WHERE p.ESTADO='ACTIVA'
GROUP BY u.USERNAME, m.NOMBRE
ORDER BY u.USERNAME, pubs_activas DESC;

SELECT * FROM V_PUBLICACIONES_ACTIVAS ORDER BY CREADO_EN DESC;

/* =========================================================================
   - RECORD y VARRAY
   - Cursores con y sin parÃ¡metros (loops anidados)
   - Excepciones predefinidas y personalizadas
============================================================================ */
-- RECORD + VARRAY: Top N skins mÃ¡s listadas (sin semilla)
DECLARE
  TYPE t_skin_rank IS RECORD(
    id_skin NUMBER,
    nombre  VARCHAR2(100),
    total   NUMBER
  );
  TYPE t_arr_skin_rank IS VARRAY(10) OF t_skin_rank;

  v_top   t_arr_skin_rank := t_arr_skin_rank();  -- arranca vacÃ­o
  v_elem  t_skin_rank;
  v_cnt   PLS_INTEGER := 0;

  CURSOR c_top IS
    SELECT s.ID_SKIN, s.NOMBRE, COUNT(*) AS total
    FROM PUBLICACIONES p
    JOIN ARTICULOS a ON a.ID_ARTICULO = p.ID_ARTICULO
    JOIN SKINS s     ON s.ID_SKIN     = a.ID_SKIN
    WHERE p.ESTADO = 'ACTIVA'
    GROUP BY s.ID_SKIN, s.NOMBRE
    ORDER BY total DESC, s.NOMBRE ASC;
BEGIN
  OPEN c_top;
  LOOP
    FETCH c_top INTO v_elem.id_skin, v_elem.nombre, v_elem.total;
    EXIT WHEN c_top%NOTFOUND OR v_cnt >= 10;
    v_cnt := v_cnt + 1;
    v_top.EXTEND;
    v_top(v_cnt) := v_elem;
  END LOOP;
  CLOSE c_top;

  IF v_top.COUNT = 0 THEN
    DBMS_OUTPUT.PUT_LINE('Top listados (hasta 10): (sin publicaciones activas)');
  ELSE
    DBMS_OUTPUT.PUT_LINE('Elementos en VARRAY: '||v_top.COUNT);
    DBMS_OUTPUT.PUT_LINE('Top listados (hasta 10):');
    FOR i IN 1..v_top.COUNT LOOP
      DBMS_OUTPUT.PUT_LINE('['||i||'] '||v_top(i).nombre||' -> '||v_top(i).total);
    END LOOP;
  END IF;
EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Error en TOP10: '||SQLERRM);
END;
/

-- Cursor CON parÃ¡metro + loops anidados: publicaciones por categorÃ­a y modelo
DECLARE
  CURSOR c_categorias IS
    SELECT ID_CATEGORIA, NOMBRE FROM CATEGORIAS_PRODUCTO;

  CURSOR c_modelos(p_id_cat NUMBER) IS
    SELECT ID_MODELO, NOMBRE FROM MODELOS_ARMA
     WHERE ID_CATEGORIA = p_id_cat;

  v_total_cat NUMBER;
BEGIN
  FOR cat IN c_categorias LOOP
    v_total_cat := 0;
    DBMS_OUTPUT.PUT_LINE('CategorÃ­a: '||cat.NOMBRE);

    FOR v_mod IN c_modelos(cat.ID_CATEGORIA) LOOP
      DECLARE
        v_cnt NUMBER;
      BEGIN
        SELECT COUNT(*)
          INTO v_cnt
          FROM PUBLICACIONES p
          JOIN ARTICULOS a ON a.ID_ARTICULO = p.ID_ARTICULO
          JOIN SKINS s     ON s.ID_SKIN     = a.ID_SKIN
         WHERE p.ESTADO = 'ACTIVA'
           AND s.ID_MODELO = v_mod.ID_MODELO;

        v_total_cat := v_total_cat + v_cnt;
        DBMS_OUTPUT.PUT_LINE('  Modelo '||v_mod.NOMBRE||': '||v_cnt||' publicaciones');
      END;
    END LOOP;

    DBMS_OUTPUT.PUT_LINE('Total categorÃ­a '||cat.NOMBRE||': '||v_total_cat);
  END LOOP;
END;
/
--Depositar saldo 
UPDATE BILLETERA_USUARIO SET SALDO_CLP=700000
 WHERE ID_USUARIO=(SELECT ID_USUARIO FROM USUARIOS WHERE USERNAME='comprador01');
INSERT INTO MOVIMIENTOS_BILLETERA(ID_USUARIO,TIPO,MONTO_CLP,REF_TX)
VALUES((SELECT ID_USUARIO FROM USUARIOS WHERE USERNAME='comprador01'),'DEPOSITO',500000,'MANUAL');
COMMIT;
SELECT COUNT(*) FROM PUBLICACIONES WHERE ESTADO='ACTIVA';
SELECT * FROM V_PUBLICACIONES_ACTIVAS ORDER BY CREADO_EN DESC;


/*
-- EJEMPLO PARA PUBLICAR UN NUEVO ARTICULO --

-- Articulos para publicar --
SELECT s.ID_SKIN, s.NOMBRE AS SKIN, m.NOMBRE AS MODELO, c.NOMBRE AS CATEGORIA
FROM SKINS s
JOIN MODELOS_ARMA m ON m.ID_MODELO = s.ID_MODELO
JOIN CATEGORIAS_PRODUCTO c ON c.ID_CATEGORIA = m.ID_CATEGORIA
ORDER BY c.NOMBRE, m.NOMBRE, s.NOMBRE;


-- ===== Crear un artÃ­culo NUEVO para vendedor02 =====
DECLARE
  v_vend USUARIOS.ID_USUARIO%TYPE;
BEGIN
  -- Obtener el ID del usuario vendedor02
  SELECT ID_USUARIO INTO v_vend
  FROM USUARIOS
  WHERE USERNAME = 'vendedor02';

  -- Insertar un nuevo artÃ­culo con la skin â€œGolden Coilâ€�
  INSERT INTO ARTICULOS(
    ID_SKIN, ID_DUENIO, DESGASTE, EXTERIOR,
    ES_STATTRAK, ES_SOUVENIR, INDICE_PATRON, NOMBRE_ETIQUETA
  )
  SELECT s.ID_SKIN, v_vend, 0.18, 'FIELD-TESTED', 'N', 'N', 333, 'COIL_NUEVO'
  FROM SKINS s
  WHERE s.NOMBRE = 'Golden Coil'; -- la skin elegida
END;
/

-- verificacion
SELECT a.ID_ARTICULO, a.NOMBRE_ETIQUETA, u.USERNAME, s.NOMBRE AS SKIN
FROM ARTICULOS a
JOIN USUARIOS u ON u.ID_USUARIO = a.ID_DUENIO
JOIN SKINS s ON s.ID_SKIN = a.ID_SKIN
ORDER BY a.ID_ARTICULO DESC;


-- ===== Publicar el artÃ­culo reciÃ©n creado =====
DECLARE
  v_vend USUARIOS.ID_USUARIO%TYPE;
  v_art  ARTICULOS.ID_ARTICULO%TYPE;
BEGIN
  -- Obtener ID del vendedor
  SELECT ID_USUARIO INTO v_vend
  FROM USUARIOS
  WHERE USERNAME = 'vendedor02';

  -- Obtener ID del artÃ­culo por su etiqueta
  SELECT ID_ARTICULO INTO v_art
  FROM ARTICULOS
  WHERE NOMBRE_ETIQUETA = 'COIL_NUEVO';

  -- Publicarlo con precio
  PKG_MERCADO.P_PUBLICAR_ARTICULO(
    p_id_vendedor => v_vend,
    p_id_articulo => v_art,
    p_precio_clp  => 175000
  );
END;
/

SELECT * FROM V_PUBLICACIONES_ACTIVAS ORDER BY CREADO_EN DESC;
*/

// UPDATE: sumar +1 al stock de todas las skins con stock >= 10
db.skins.updateMany(
  { stock: { $gte: 10 } },     // Filtro: solo skins con stock 10 o más
  { $inc: { stock: 1 } }       // Operación: incrementa el stock en +1
);

// UPDATE: sumar +1 al stock de todas las skins con stock < 10
db.skins.updateMany(
  { stock: { $lt: 10 } },   // MENOR que 10
  { $inc: { stock: 1 } }
);
